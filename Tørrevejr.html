<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Skal vasketøjet ud?</title>
    <style>
        body {
            font-size: 24px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else { 
                document.getElementById("errorGPS").innerHTML = "GPS Lokation er ikke tilgængelig via din browser.";
            }
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    document.getElementById("errorGPS").innerHTML = "Du skal acceptere at bruge GPS Data.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    document.getElementById("errorGPS").innerHTML = "Din lokation er ikke tilgængelig.";
                    break;
                case error.TIMEOUT:
                    document.getElementById("errorGPS").innerHTML = "Det tog for lang tid med at finde din lokation.";
                    break;
                case error.UNKNOWN_ERROR:
                    document.getElementById("errorGPS").innerHTML = "En ukendt fejl er opstået.";
                    break;
            }
        }

        function showPosition(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            var api_key = 'bb95120518eb14ab25ee3a89ad9769ec';
            var api_url = 'https://api.openweathermap.org/data/2.5/forecast?lat=' + latitude + '&lon=' + longitude + '&appid=' + api_key;

            $.getJSON(api_url)
                .done(function(data) {
                    var days = ['Søndag', 'Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lørdag'];
                    var forecast = data.list.slice(0, 24 * 7); // get the next 7 days of data
                    var location = data.city.name;
                    document.getElementById("heading").innerHTML = "Skal vasketøjet ud?";
                    var good_drying_days = {};

                    forecast.forEach(function(item) {
                        var weather = item.weather[0].main;
                        var humidity = item.main.humidity;
                        var dt_txt = item.dt_txt;
                        var hour = new Date(dt_txt).getHours();
                        var day = days[new Date(dt_txt).getDay()];

                        if (hour >= 8 && hour <= 22 && weather != 'Rain' && weather != 'Snow' && weather != 'Sleet' && humidity < 75) {
                            if (!good_drying_days.hasOwnProperty(day)) {
                                good_drying_days[day] = [];
                            }
                            good_drying_days[day].push(hour);
                        }
                    });

                    var output = document.getElementById("output");
                    var hasGoodDays = false;

                    for (var day in good_drying_days) {
                        var day_hours = good_drying_days[day];
                        day_hours.sort((a, b) => a - b); // sort the hours

                        var consolidated_hours = [];
                        var start_hour = day_hours[0];
                        var end_hour = day_hours[0];

                        for (var i = 1; i < day_hours.length; i++) {
                            if (day_hours[i] == end_hour + 1) {
                                end_hour = day_hours[i]; // extend the current interval
                            } else {
                                if (end_hour - start_hour >= 3) {
                                    consolidated_hours.push([start_hour, end_hour]); // add the current interval if it's at least 3 hours long
                                    hasGoodDays = true;
                                }
                                start_hour = day_hours[i];
                                end_hour = day_hours[i];
                            }
                        }

                        if (end_hour - start_hour >= 3) {
                            consolidated_hours.push([start_hour, end_hour]); // add the last interval if it's at least 3 hours long
                            hasGoodDays = true;
                        }

                        if (hasGoodDays && consolidated_hours.length > 0) {
                            var intervals = consolidated_hours.map(hours => hours.join('-')).join(', ');
                            var averageHumidity = consolidated_hours.reduce((sum, hours) => {
                                var startIdx = hours[0] - 8;
                                var endIdx = hours[1] - 8;
                                var sumHumidity = 0;
                                for (var i = startIdx; i <= endIdx; i++) {
                                    sumHumidity += forecast[i].main.humidity;
                                }
                                return sum + sumHumidity / (endIdx - startIdx + 1);
                            }, 0) / consolidated_hours.length;
                            averageHumidity = averageHumidity.toFixed(2);
                            var div = document.createElement("div");
                            div.textContent = day + ": " + intervals + " (Gennemsnitlig luftfugtighed: " + averageHumidity + "%)";
                            output.appendChild(div);
                        }
                    }

                    if (!hasGoodDays) {
                        var noGoodDaysMessage = document.createElement("div");
                        noGoodDaysMessage.textContent = "Der er desværre ingen gode dage til at tørre vasketøjet.";
                        output.appendChild(noGoodDaysMessage);
                    }
                    document.getElementById("location").innerHTML = "Din nuværende by er: " + location + ".";
                })
                .fail(function(jqxhr, textStatus, error) {
                    var err = textStatus + ", " + error;
                    console.log("Request Failed: " + err);
                    document.getElementById("errorAPI").innerHTML = "Request Failed: " + err;
                });
        }
    </script>
  </head>
  <body onload="getLocation()">
    <div id="errorGPS"></div>
    <h1 id="heading"></h1>
    <div id="output"></div>
    <div id="location"></div>
    <div id="errorAPI"></div>
  </body>
</html>
