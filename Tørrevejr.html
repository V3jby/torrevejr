<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Skal vasketøjet ud?</title>
    <style>
        body {
            font-size: 24px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                document.getElementById("errorGPS").innerHTML = "GPS Lokation er ikke tilgængelig via din browser.";
            }
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    document.getElementById("errorGPS").innerHTML = "Du skal acceptere at bruge GPS Data.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    document.getElementById("errorGPS").innerHTML = "Din lokation er ikke tilgængelig.";
                    break;
                case error.TIMEOUT:
                    document.getElementById("errorGPS").innerHTML = "Det tog for lang tid med at finde din lokation.";
                    break;
                case error.UNKNOWN_ERROR:
                    document.getElementById("errorGPS").innerHTML = "En ukendt fejl er opstået.";
                    break;
            }
        }

        function showPosition(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            var api_key = 'bb95120518eb14ab25ee3a89ad9769ec';
            var api_url = 'https://api.openweathermap.org/data/2.5/forecast?lat=' + latitude + '&lon=' + longitude + '&appid=' + api_key;

            $.getJSON(api_url, function(data) {
                var days = ['Søndag', 'Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lørdag'];
                var intervals = {'Morgen': [8, 11], 'Formiddag': [11, 14], 'Eftermiddag': [14, 17], 'Aften': [17, 22]};
                var forecast = data.list.slice(0, 24 * 5); // get the next 5 days of data
                var location = data.city.name;
                document.getElementById("location").innerHTML = "Din nuværende by er: " + location + ".";
                document.getElementById("heading").innerHTML = "Skal vasketøjet ud?";

                var good_drying_days = {};

                forecast.forEach(function(item) {
                    var weather = item.weather[0].main;
                    var humidity = item.main.humidity;
                    var dt_txt = item.dt_txt;
                    var hour = new Date(dt_txt).getHours();
                    var day = days[new Date(dt_txt).getDay()];
                    
                    if (weather != 'Rain' && humidity < 75) {
                        for (var interval in intervals) {
                            if (hour >= intervals[interval][0] && hour < intervals[interval][1]) {
                                if (!good_drying_days.hasOwnProperty(day)) {
                                    good_drying_days[day] = [];
                                }
                                good_drying_days[day].push(interval);
                            }
                        }
                    }
                });
                
                // Consolidating the time intervals
                for (var day in good_drying_days) {
                    var output = document.getElementById("output");
                    var div = document.createElement("div");
                    var day_intervals = good_drying_days[day].filter((v, i, a) => a.indexOf(v) === i); // removing duplicate intervals
                    day_intervals.sort((a, b) => intervals[a][0] - intervals[b][0]); // sort the intervals
                    var merged_intervals = [day_intervals[0]]; // initializing with the first interval

                    for (var i = 1; i < day_intervals.length; i++) {
                        var last_interval = merged_intervals[merged_intervals.length - 1];
                        var current_interval = day_intervals[i];
                        if (intervals[last_interval][1] >= intervals[current_interval][0]) {
                            merged_intervals[merged_intervals.length - 1] = current_interval; // replace the last interval
                        } else {
                            merged_intervals.push(current_interval); // add a new interval
                        }
                    }
                    
                    div.textContent = day + ": " + merged_intervals.map(interval => intervals[interval].join('-')).join(' og ') + " (Luftfugtighed under 75%).";
                    output.appendChild(div);
                }
            });
        }
    </script>
  </head>
  <body onload="getLocation()">
    <h1 id="heading"></h1>
    <div id="errorGPS"></div>
    <div id="location"></div>
    <div id="output"></div>
  </body>
</html>
