<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Skal vasketøjet ud?</title>
    <style>
        body {
            font-size: 36px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                document.getElementById("errorGPS").innerHTML = "GPS Lokation er ikke tilgængelig via din browser.";
            }
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    document.getElementById("errorGPS").innerHTML = "Du skal acceptere at bruge GPS Data.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    document.getElementById("errorGPS").innerHTML = "Din lokation er ikke tilgængelig.";
                    break;
                case error.TIMEOUT:
                    document.getElementById("errorGPS").innerHTML = "Det tog for lang tid med at finde din lokation.";
                    break;
                case error.UNKNOWN_ERROR:
                    document.getElementById("errorGPS").innerHTML = "En ukendt fejl er opstået.";
                    break;
            }
        }

        function showPosition(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            var api_key = 'bb95120518eb14ab25ee3a89ad9769ec';
            var api_url = 'https://api.openweathermap.org/data/2.5/forecast?lat=' + latitude + '&lon=' + longitude + '&appid=' + api_key;

            $.getJSON(api_url, function(data) {
                var days = ['Søndag', 'Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lørdag'];
                var intervals = {'Morgen': [8, 11], 'Formiddag': [11, 14], 'Eftermiddag': [14, 17], 'Aften': [17, 22]};
                var forecast = data.list.slice(0, 24 * 5); // get the next 5 days of data

                var good_drying_days = {};

                forecast.forEach(function(item) {
                    var date = new Date(item.dt_txt);
                    var day_name = days[date.getDay()];
                    var hour = date.getHours();
                    var humidity = item.main.humidity;
                    var weather = item.weather[0].main;

                    if (weather != 'Rain' && humidity < 75) {
                        Object.keys(intervals).forEach(function(interval) {
                            if (hour >= intervals[interval][0] && hour < intervals[interval][1]) {
                                if (!good_drying_days[day_name]) {
                                    good_drying_days[day_name] = {intervals: [], maxHumidity: humidity};
                                }
                                if (!good_drying_days[day_name].intervals.includes(interval)) {
                                    good_drying_days[day_name].intervals.push(interval);
                                    good_drying_days[day_name].maxHumidity = Math.max(humidity, good_drying_days[day_name].maxHumidity);
                                }
                            }
                        });
                    }
                });

                // print out good drying days
                console.log('Skal vasketøjet ud?');
                Object.keys(good_drying_days).forEach(function(day) {
                    if(good_drying_days[day].intervals.length > 0) {
                        console.log(day + ': Godt tørrevejr i ' + good_drying_days[day].intervals.join(', '));
                    }
                });
                console.log('\nDin nuværende by er: ' + data.city.name);
            });
        }

        $(document).ready(function(){
            getLocation();
        });
    </script>
  </head>
  <body>
    <div id="errorGPS"></div>
  </body>
</html>
