<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Skal vasketøjet ud?</title>
	<style>
      	body {
        	font-size: 36px;
		}
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
		function getLocation() {
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(showPosition, showError);
			} else {
				document.getElementById("errorGPS").innerHTML = "GPS Lokation er ikke tilgængelig via din browser.";
			}
		}

		function showError(error) {
			switch(error.code) {
				case error.PERMISSION_DENIED:
					document.getElementById("errorGPS").innerHTML = "Du skal acceptere at bruge GPS Data.";
					break;
				case error.POSITION_UNAVAILABLE:
					document.getElementById("errorGPS").innerHTML = "Din lokation er ikke tilgængelig.";
					break;
				case error.TIMEOUT:
					document.getElementById("errorGPS").innerHTML = "Det tog for lang tid med at finde din lokation.";
					break;
				case error.UNKNOWN_ERROR:
					document.getElementById("errorGPS").innerHTML = "En ukendt fejl er opstået.";
					break;
			}
		}

        function showPosition(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            var api_key = 'bb95120518eb14ab25ee3a89ad9769ec';
            var api_url = 'https://api.openweathermap.org/data/2.5/forecast?lat=' + latitude + '&lon=' + longitude + '&appid=' + api_key;

            $.getJSON(api_url, function(data) {
                var days = ['Søndag', 'Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lørdag'];
                var intervals = {'Morgen': [8, 11], 'Formiddag': [11, 14], 'Eftermiddag': [14, 17], 'Aften': [17, 22]};
                var forecast = data.list.slice(0, 24 * 5); // get the next 5 days of data

                var good_drying_days = {};
                var bad_drying_days = {};

                forecast.forEach(function(item) {
                    var date = new Date(item.dt_txt);
                    var day_name = days[date.getDay()];
                    var hour = date.getHours();
                    var humidity = item.main.humidity;
                    var weather = item.weather[0].main;

                    if (weather != 'Rain' && humidity < 75) {
                        Object.keys(intervals).forEach(function(interval) {
                            if (hour >= intervals[interval][0] && hour < intervals[interval][1]) {
                                if (!good_drying_days[day_name]) {
                                    good_drying_days[day_name] = {intervals: [], maxHumidity: humidity};
                                }
                                if (!good_drying_days[day_name].intervals.includes(interval)) {
                                    good_drying_days[day_name].intervals.push(interval);
                                    good_drying_days[day_name].maxHumidity = Math.max(humidity, good_drying_days[day_name].maxHumidity);
                                }
                            }
                        });
                    } else {
                        Object.keys(intervals).forEach(function(interval) {
                            if (hour >= intervals[interval][0] && hour < intervals[interval][1]) {
                                if (!bad_drying_days[day_name]) {
                                    bad_drying_days[day_name] = {intervals: [], maxHumidity: humidity};
                                }
                                if (!bad_drying_days[day_name].intervals.includes(interval)) {
                                    bad_drying_days[day_name].intervals.push(interval);
                                    bad_drying_days[day_name].maxHumidity = Math.max(humidity, bad_drying_days[day_name].maxHumidity);
                                }
                            }
                        });
                    }
                });

                var result = 'Skal vasketøjet ud?<br>';
                Object.keys(good_drying_days).forEach(function(day_name) {
                    var intervals = good_drying_days[day_name].intervals;
                    var maxHumidity = good_drying_days[day_name].maxHumidity;
                    if (intervals.length === 4) {
                        result += day_name + ': Godt tørrevejr 8-22.<br>';
                    } else {
                        var times = consolidateIntervals(intervals);
                        times.forEach(function(time) {
                            result += day_name + ': Godt tørrevejr ' + time.start + '-' + time.end + '.<br>';
                        });
                    }
                });
                Object.keys(bad_drying_days).forEach(function(day_name) {
                    var intervals = bad_drying_days[day_name].intervals;
                    var maxHumidity = bad_drying_days[day_name].maxHumidity;
                    result += day_name + ': Dårligt tørrevejr ' + intervals.join(', ') + ', Max Luftfugtighed: ' + maxHumidity + '%.<br>';
                });
                $('#result').html(result);
            });

            var url = 'https://nominatim.openstreetmap.org/reverse?format=json&lat=' + latitude + '&lon=' + longitude;
            fetch(url) 
                .then(response => response.json())
                .then(data => {
                    var cityName = null;
                    var address = data.address;
                    if (address.city) {
                        cityName = address.city;
                    } else if (address.town) {
                        cityName = address.town;
                    } else if (address.village) {
                        cityName = address.village;
                    } else if (address.hamlet) {
                        cityName = address.hamlet;
                    }
                    document.getElementById("cityName").innerHTML = "Din nuværende by er: " + cityName;
                });
        }

        function consolidateIntervals(intervals) {
            var times = {'Morgen': 8, 'Formiddag': 11, 'Eftermiddag': 14, 'Aften': 17};
            var end_times = {'Morgen': 11, 'Formiddag': 14, 'Eftermiddag': 17, 'Aften': 22};
            var output = [];
            var start = null;
            var end = null;
            Object.keys(times).forEach(function(interval) {
                if (intervals.includes(interval)) {
                    if (start == null) {
                        start = times[interval];
                    }
                    end = end_times[interval];
                } else {
                    if (start != null) {
                        output.push({start: start, end: end});
                        start = null;
                        end = null;
                    }
                }
            });
            if (start != null) {
                output.push({start: start, end: end});
            }
            return output;
        }

        $(document).ready(function() {
            getLocation();
        });
    </script>
  </head>
  <body>
    <h1 id="result">Afventer GPS Lokation...</h1>
    <h2 id="cityName"></h2>
    <h3 id="errorGPS"></h3>
  </body>
</html>
