<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Skal vasketøjet ud?</title>
    <style>
        body {
            font-size: 24px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else { 
                document.getElementById("errorGPS").innerHTML = "GPS Lokation er ikke tilgængelig via din browser.";
            }
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    document.getElementById("errorGPS").innerHTML = "Du skal acceptere at bruge GPS Data.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    document.getElementById("errorGPS").innerHTML = "Din lokation er ikke tilgængelig.";
                    break;
                case error.TIMEOUT:
                    document.getElementById("errorGPS").innerHTML = "Det tog for lang tid med at finde din lokation.";
                    break;
                case error.UNKNOWN_ERROR:
                    document.getElementById("errorGPS").innerHTML = "En ukendt fejl er opstået.";
                    break;
            }
        }

        function showPosition(position) {
            var latitude = position.coords.latitude;
            var longitude = position.coords.longitude;
            var api_key = 'bb95120518eb14ab25ee3a89ad9769ec';
            var api_url = 'https://api.openweathermap.org/data/2.5/forecast?lat=' + latitude + '&lon=' + longitude + '&appid=' + api_key;

            $.getJSON(api_url, function(data) {
                var days = ['Søndag', 'Mandag', 'Tirsdag', 'Onsdag', 'Torsdag', 'Fredag', 'Lørdag'];
                var forecast = data.list.slice(0, 24 * 5); // get the next 5 days of data
                var location = data.city.name;
                document.getElementById("heading").innerHTML = "Skal vasketøjet ud?";

                var good_drying_days = {};
                var humidity_data = {};

                forecast.forEach(function(item) {
                    var weather = item.weather[0].main;
                    var humidity = item.main.humidity;
                    var dt_txt = item.dt_txt;
                    var hour = new Date(dt_txt).getHours();
                    var day = days[new Date(dt_txt).getDay()];
                    
                    if (weather != 'Rain' && humidity < 75) {
                        if (!good_drying_days.hasOwnProperty(day)) {
                            good_drying_days[day] = [];
                            humidity_data[day] = [];
                        }
                        good_drying_days[day].push(hour);
                        humidity_data[day].push(humidity);
                    }
                });

                // Consolidating the time intervals
                for (var day in good_drying_days) {
                    var output = document.getElementById("output");
                    var div = document.createElement("div");
                    var day_hours = good_drying_days[day];
                    day_hours.sort((a, b) => a - b); // sort the hours

                    var consolidated_hours = [];
                    var start_hour = day_hours[0];
                    var end_hour = day_hours[0];

                    for (var i = 1; i < day_hours.length; i++) {
                        if (day_hours[i] == end_hour + 1) {
                            end_hour = day_hours[i]; // extend the current interval
                        } else {
                            if (end_hour - start_hour >= 2) {
                                consolidated_hours.push([start_hour, end_hour + 1]); // add the current interval if it's at least 3 hours long
                            }
                            start_hour = day_hours[i];
                            end_hour = day_hours[i];
                        }
                    }

                    if (end_hour - start_hour >= 2) {
                        consolidated_hours.push([start_hour, end_hour + 1]); // add the last interval if it's at least 3 hours long
                    }
                    
                    var average_humidity = Math.round(humidity_data[day].reduce((a, b) => a + b) / humidity_data[day].length);
                    
                    if (consolidated_hours.length > 0) {
                        div.textContent = day + ": " + consolidated_hours.map(hours => hours.join('-')).join(' og ') + " (Gennemsnitlig luftfugtighed: " + average_humidity + "%).";
                        output.appendChild(div);
                    }
                }
                document.getElementById("location").innerHTML = "Din nuværende by er: " + location + ".";
            });
        }
    </script>
  </head>
  <body onload="getLocation()">
    <div id="errorGPS"></div>
    <h1 id="heading"></h1>
    <div id="output"></div>
    <div id="location"></div>
  </body>
</html>
